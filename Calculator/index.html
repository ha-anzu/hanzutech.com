<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content">
  <script>
    if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hanzu Tech</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=IBM+Plex+Sans:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background-color: #0a0a0f; color: white; font-family: 'IBM Plex Mono', monospace; }
    h1, h2 { font-family: 'IBM Plex Sans', sans-serif; font-weight: bold; }
    .neon-red { color: #ff0033; text-shadow: 0 0 10px #ff0033; }
    .neon-yellow { color: #ffcc00; text-shadow: 0 0 10px #ffcc00; }
    .technically-mark {
      display: inline-block;
      font-size: 1rem;
      line-height: 1;
      font-weight: 700;
      letter-spacing: 0.38em;
      text-transform: uppercase;
      color: #ffcc00;
      text-shadow: 0 0 14px rgba(255, 204, 0, 0.4);
    }
    .card { background-color: black; border: 1px solid #ff0033; padding: 2rem; transition: transform 0.3s; }
    .card:hover { transform: scale(1.01); box-shadow: 0 0 20px #ffcc00; }
    .button { padding: 1rem 2rem; border: 2px solid #ffcc00; color: black; background-color: #ff0033; transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s; }
    .button:hover { background-color: #ffcc00; border-color: #ff0033; transform: translateY(-2px); box-shadow: 0 0 20px rgba(255, 204, 0, 0.22); }
    .flicker { animation: flicker 2s infinite; }
    @keyframes flicker { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; } 20%, 22%, 24%, 55% { opacity: 0.5; } }
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 18px rgba(255, 0, 51, 0.12), inset 0 0 0 rgba(255, 204, 0, 0); }
      50% { box-shadow: 0 0 30px rgba(255, 204, 0, 0.16), inset 0 0 0 rgba(255, 204, 0, 0); }
    }
    @keyframes hueSweep {
      0% { background-position: 0 0; }
      100% { background-position: 180px 0; }
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 15%, rgba(255, 0, 51, 0.16), transparent 22%),
        radial-gradient(circle at 84% 12%, rgba(255, 204, 0, 0.12), transparent 18%),
        linear-gradient(rgba(255,255,255,0.025) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.025) 1px, transparent 1px);
      background-size: auto, auto, 78px 78px, 78px 78px;
      pointer-events: none;
      z-index: -2;
    }
    .interface-shell {
      background:
        linear-gradient(180deg, rgba(0,0,0,0.82), rgba(0,0,0,0.72)),
        linear-gradient(120deg, rgba(255, 0, 51, 0.08), transparent 35%, rgba(255, 204, 0, 0.08));
      border: 1px solid rgba(255, 0, 51, 0.3);
      box-shadow: 0 0 30px rgba(255, 0, 51, 0.12);
      animation: pulseGlow 5s ease-in-out infinite;
    }
    .panel {
      background: rgba(0, 0, 0, 0.72);
      border: 1px solid rgba(255, 0, 51, 0.25);
      backdrop-filter: blur(12px);
    }
    .terminal-accent {
      background-image: linear-gradient(90deg, rgba(255,0,51,0.16), rgba(255,204,0,0.18), rgba(255,0,51,0.16));
      background-size: 180px 100%;
      animation: hueSweep 6s linear infinite;
    }
    input, textarea, select {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 0, 51, 0.28);
      color: white;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: rgba(255, 204, 0, 0.9);
      box-shadow: 0 0 0 1px rgba(255, 204, 0, 0.16), 0 0 18px rgba(255, 204, 0, 0.12);
    }
    .invoice-container {
      width: 210mm;
      min-height: 297mm;
      padding: 15mm;
      margin: auto;
      background: #fffdf8;
      color: #171717;
      box-shadow: 0 0 40px rgba(255, 0, 51, 0.12);
    }
    .invoice-header {
      background: linear-gradient(135deg, #140308, #400511 70%, #7a0f1d);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .invoice-table th {
      background-color: #fff3d1;
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ead9b6;
      font-weight: 700;
      font-size: 9pt;
      text-transform: uppercase;
    }
    .invoice-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f2ebdd;
      vertical-align: top;
    }
    .total-column {
      background-color: #fff8e7;
      width: 120px;
      text-align: right;
      font-weight: 700;
    }
    .preview-image-box {
      border: 1px dashed rgba(255, 0, 51, 0.35);
      width: 100%;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(255, 0, 51, 0.04), rgba(255, 204, 0, 0.06));
      overflow: hidden;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #050507; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 0, 51, 0.4); border-radius: 999px; }
    @media print {
      body * { visibility: hidden; }
      #invoice-preview, #invoice-preview * { visibility: visible; }
      #invoice-preview { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="fixed top-0 left-0 w-full bg-black bg-opacity-90 p-4 flex justify-between z-50 border-b border-red-600/30 backdrop-blur-md no-print">
    <div class="text-3xl font-bold neon-red">HANZU TECH</div>
    <div class="space-x-8">
      <a href="/jewelers" class="neon-yellow">Jewelers Tools</a>
      <a href="https://hanzu.dev" class="neon-yellow">The DEV</a>
      <a href="/about" class="neon-yellow">About Us</a>
    </div>
  </div>

  <main class="pt-24 pb-12 px-4 md:px-6 no-print">
    <section class="max-w-7xl mx-auto mb-6 interface-shell px-6 py-8 md:px-8">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.4em] text-gray-500 mb-2">Jewelers Tools / Calculator</p>
          <span class="technically-mark mb-1">technically</span>
          <h1 class="text-4xl md:text-6xl uppercase neon-red">Designer</h1>
          <p class="mt-2 text-base md:text-lg uppercase tracking-[0.22em] text-gray-300">AKA Jack of All Trades</p>
          <p class="mt-4 max-w-3xl text-gray-300 leading-7">Live quotation builder with cyberpunk discipline. No history, no browser storage, no saved client records. Build the quote, export it, then the session disappears when you leave.</p>
        </div>
        <div class="panel px-4 py-3 text-sm text-gray-300">
          <div class="terminal-accent h-1 w-full mb-3"></div>
          <p class="uppercase tracking-[0.28em] text-gray-500 text-xs">Session Mode</p>
          <p class="neon-yellow">Private local-only workflow</p>
        </div>
      </div>
    </section>

    <section class="max-w-7xl mx-auto flex flex-col xl:flex-row gap-6">
      <aside class="w-full xl:w-[430px] panel p-5 md:p-6 space-y-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.4em] text-gray-500">Quote Controls</p>
            <p class="text-sm text-gray-300 mt-1">Ephemeral session only</p>
          </div>
          <div class="flex gap-2">
            <button onclick="createNewQuotation()" class="button text-sm px-4 py-2">New Quote</button>
            <button onclick="window.print()" class="button text-sm px-4 py-2 bg-transparent text-yellow-300">Print</button>
          </div>
        </div>

        <section class="space-y-4">
          <h2 class="text-xs uppercase tracking-[0.4em] text-gray-500">Client Details</h2>
          <div>
            <label class="block text-xs text-gray-400 mb-2">Client Name</label>
            <input type="text" id="client-name" oninput="updatePreview()" placeholder="Client name" class="w-full px-3 py-2">
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-2">Shipping Address</label>
            <textarea id="client-address" oninput="updatePreview()" rows="3" placeholder="Address..." class="w-full px-3 py-2"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-gray-400 mb-2">Invoice #</label>
              <input type="text" id="invoice-number" oninput="updatePreview()" class="w-full px-3 py-2">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-2">Date</label>
              <input type="date" id="invoice-date" oninput="updatePreview()" class="w-full px-3 py-2">
            </div>
          </div>
        </section>

        <section class="space-y-4">
          <h2 class="text-xs uppercase tracking-[0.4em] text-gray-500">Reference Image</h2>
          <label for="image-upload" class="flex flex-col items-center justify-center w-full h-32 border border-dashed border-red-600/40 bg-black/70 cursor-pointer hover:border-yellow-400 transition-colors">
            <i class="fas fa-cloud-upload-alt text-2xl neon-red mb-2"></i>
            <span class="text-xs text-gray-400">Upload reference image</span>
          </label>
          <input id="image-upload" type="file" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
        </section>

        <section class="space-y-4 panel p-4">
          <div class="flex justify-between items-center">
            <h2 class="text-xs uppercase tracking-[0.4em] text-gray-500">Metal Configuration</h2>
            <button onclick="applyApiKey()" class="text-xs neon-yellow">Set API Key</button>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-2">Metal Type</label>
            <select id="metal-type" onchange="onMetalTypeChange()" class="w-full px-3 py-2">
              <option value="XAG" data-purity="0.925">Sterling Silver 925</option>
              <option value="XAU" data-purity="0.583">14K Gold</option>
              <option value="XAU" data-purity="0.750" selected>18K Gold (Yellow/White/Rose)</option>
              <option value="XPT" data-purity="0.950">Platinum 950</option>
              <option value="XPD" data-purity="0.950">Palladium 950</option>
              <option value="CUSTOM" data-purity="1.000">Custom Metal</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-gray-400 mb-2">Finished Wt (g)</label>
              <input type="number" id="metal-weight" step="0.01" value="19.00" oninput="updatePreview()" class="w-full px-3 py-2">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-2">Loss %</label>
              <input type="number" id="metal-loss" step="0.1" value="11.0" oninput="updatePreview()" class="w-full px-3 py-2">
            </div>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-2">Unit Price ($/g)</label>
            <input type="number" id="metal-unit-price" step="0.01" oninput="updatePreview()" class="w-full px-3 py-2">
            <p id="spot-status" class="text-[11px] mt-2 text-gray-500">Manual price by default. API key lives only in this active tab.</p>
          </div>
          <button onclick="fetchMetalPrice()" id="fetch-btn" class="button w-full text-sm">Fetch Spot</button>
        </section>

        <section class="space-y-4">
          <div class="flex justify-between items-center">
            <h2 class="text-xs uppercase tracking-[0.4em] text-gray-500">Stones</h2>
            <button onclick="addStoneRow()" class="text-xs neon-yellow">Add Stone</button>
          </div>
          <div id="stones-container" class="space-y-3"></div>
        </section>

        <section class="space-y-4">
          <div class="flex justify-between items-center">
            <h2 class="text-xs uppercase tracking-[0.4em] text-gray-500">Labor & Services</h2>
            <button onclick="addLaborRow()" class="text-xs neon-yellow">Add Service</button>
          </div>
          <div id="labor-container" class="space-y-3"></div>
        </section>

        <section class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-gray-400 mb-2">VAT %</label>
            <input type="number" id="vat-percent" step="0.1" value="0" oninput="updatePreview()" class="w-full px-3 py-2">
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-2">Deposit ($)</label>
            <input type="number" id="deposit-amount" step="1" value="0" oninput="updatePreview()" class="w-full px-3 py-2">
          </div>
        </section>

        <div class="flex gap-3">
          <button onclick="loadSampleData()" class="button w-full text-sm">Load Sample</button>
          <button onclick="exportPDF()" class="button w-full text-sm bg-transparent text-yellow-300">Export PDF</button>
        </div>
      </aside>

      <section class="flex-1 panel p-3 md:p-6 overflow-auto">
        <div id="invoice-preview" class="invoice-container">
          <div class="invoice-header">
            <div>
              <p style="font-size: 8pt; letter-spacing: 0.4em; text-transform: uppercase; opacity: 0.75;">Hanzu Tech / Jewelers Tools</p>
              <h1 style="font-size: 26pt; margin-top: 6px;">Quotation</h1>
              <p style="font-size: 10pt; margin-top: 4px; opacity: 0.82;">Precision estimate for custom jewelry work</p>
            </div>
            <div style="text-align: right;">
              <p style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3em; opacity: 0.75;">Invoice</p>
              <p id="preview-invoice-num" style="font-size: 18pt; font-weight: bold;">HZ-0001</p>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; padding: 30px 0; border-bottom: 1px solid #f2ebdd;">
            <div>
              <h3 style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3em; color: #6b7280; margin-bottom: 8px;">Client Information</h3>
              <p id="preview-client-name" style="font-size: 16pt; font-weight: bold;">CLIENT NAME</p>
              <p id="preview-client-address" style="font-size: 10pt; color: #6b7280; white-space: pre-line;">Shipping Address Details</p>
            </div>
            <div style="text-align: right;">
              <h3 style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3em; color: #6b7280; margin-bottom: 8px;">Issue Date</h3>
              <p id="preview-date" style="font-size: 11pt;">MM/DD/YYYY</p>
            </div>
          </div>

          <div style="display: flex; margin-top: 24px; min-height: 400px;">
            <div style="width: 32%; padding-right: 24px; border-right: 1px solid #f2ebdd;">
              <div class="preview-image-box mb-2">
                <img id="preview-image" src="" alt="" class="max-w-full max-h-full object-contain hidden">
                <div id="image-placeholder" style="text-align: center; color: #9ca3af; padding: 20px;">
                  <i class="fas fa-image" style="font-size: 38px; margin-bottom: 8px;"></i>
                  <p style="font-size: 8pt;">REFERENCE IMAGE</p>
                </div>
              </div>
              <div style="font-size: 8pt; color: #9ca3af; text-align: center;">For design reference only</div>
            </div>
            <div style="width: 68%; padding-left: 24px;">
              <table class="w-full invoice-table">
                <thead>
                  <tr>
                    <th class="w-1/2">Description / Info</th>
                    <th>Units</th>
                    <th>Unit Price</th>
                    <th class="total-column">Total</th>
                  </tr>
                </thead>
                <tbody id="preview-table-body"></tbody>
              </table>
            </div>
          </div>

          <div style="margin-top: 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
            <div>
              <h3 style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3em; color: #6b7280; margin-bottom: 8px;">Terms</h3>
              <p style="font-size: 8pt; color: #6b7280;">Custom orders typically require a deposit before production. Final figures should be reviewed before sending to a client.</p>
              <div style="margin-top: 16px; padding: 12px; background: #fff8e7; border: 1px solid #ead9b6;">
                <p style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3em; color: #7a0f1d; margin-bottom: 6px;">Security Note</p>
                <p style="font-size: 8pt; color: #4b5563;">No client data is collected or saved by this tool. Close the page and the session ends.</p>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; font-size: 9pt; padding: 4px 0;">
                <span style="color: #6b7280;">Subtotal</span>
                <span id="preview-subtotal">$0.00</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 9pt; padding: 4px 0;">
                <span style="color: #6b7280;">VAT (<span id="preview-vat-rate">0</span>%)</span>
                <span id="preview-vat-amount">$0.00</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 18pt; font-weight: bold; border-top: 1px solid #ead9b6; padding-top: 8px; margin-top: 8px;">
                <span>Grand Total</span>
                <span id="preview-grand-total">$0.00</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 9pt; color: #7a0f1d; font-weight: bold; padding: 4px 0;">
                <span>Deposit Paid</span>
                <span id="preview-deposit">-$0.00</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 20pt; font-weight: bold; background: #140308; color: white; padding: 10px 12px; margin-top: 8px;">
                <span>Balance Due</span>
                <span id="preview-balance">$0.00</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <section class="max-w-7xl mx-auto mt-6 panel p-5 md:p-6">
      <p class="text-xs uppercase tracking-[0.4em] text-gray-500 mb-3">Privacy Note</p>
      <p class="text-gray-300 leading-7">This calculator does not store quote history, does not use browser storage, and does not collect or save client data. Information remains only in the current page until you export or close it.</p>
    </section>
  </main>

  <footer class="bg-black p-4 text-xs text-gray-500 mt-8 border-t border-red-600/20">
    <div class="max-w-6xl mx-auto space-y-2 text-center md:text-left md:pl-8">
      <p class="neon-red flicker">Designed by Hanzu</p>
      <p><a href="/privacy">Privacy</a> â€¢ <a href="/legal">Legal</a></p>
    </div>
  </footer>

  <script>
    let appState = {
      clientName: '',
      clientAddress: '',
      invoiceNumber: 'HZ-' + Math.floor(1000 + Math.random() * 9000),
      date: new Date().toISOString().split('T')[0],
      image: '',
      metal: {
        type: 'XAU',
        purity: 0.750,
        weight: 19.0,
        loss: 11.0,
        unitPrice: 0
      },
      stones: [],
      labor: [
        { id: Date.now(), description: 'Casting / Setting / Finishing Labour', qty: 1, unit: 'Piece', price: 200 },
        { id: Date.now() + 1, description: 'Plating / Surface Treatment', qty: 1, unit: 'Piece', price: 45 }
      ],
      vat: 0,
      deposit: 0,
      apiKey: ''
    };

    window.onload = () => {
      document.getElementById('invoice-number').value = appState.invoiceNumber;
      document.getElementById('invoice-date').value = appState.date;
      document.getElementById('metal-unit-price').value = appState.metal.unitPrice;
      renderStones();
      renderLabor();
      updatePreview();
    };

    function applyApiKey() {
      const key = window.prompt('Enter GoldAPI.io key for this session only. It will not be saved.', appState.apiKey);
      if (key !== null) {
        appState.apiKey = key.trim();
        document.getElementById('spot-status').textContent = appState.apiKey ? 'API key loaded for this tab only.' : 'Manual price by default. API key lives only in this active tab.';
      }
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        appState.image = e.target.result;
        updatePreview();
      };
      reader.readAsDataURL(file);
    }

    function onMetalTypeChange() {
      const select = document.getElementById('metal-type');
      const option = select.options[select.selectedIndex];
      appState.metal.type = select.value;
      appState.metal.purity = parseFloat(option.dataset.purity);
      updatePreview();
    }

    function addStoneRow() {
      appState.stones.push({ id: Date.now(), type: 'Sapphire', carats: 0, price: 0 });
      renderStones();
      updatePreview();
    }

    function removeStone(id) {
      appState.stones = appState.stones.filter((stone) => stone.id !== id);
      renderStones();
      updatePreview();
    }

    function updateStone(id, field, value) {
      const stone = appState.stones.find((item) => item.id === id);
      if (!stone) return;
      stone[field] = field === 'type' ? value : parseFloat(value) || 0;
      updatePreview();
    }

    function renderStones() {
      const container = document.getElementById('stones-container');
      container.innerHTML = appState.stones.map((stone) => `
        <div class="panel p-3 space-y-2">
          <div class="flex justify-between items-center">
            <select onchange="updateStone(${stone.id}, 'type', this.value)" class="text-xs font-bold bg-transparent w-full mr-3 px-2 py-2">
              <option ${stone.type === 'Sapphire' ? 'selected' : ''}>Sapphire</option>
              <option ${stone.type === 'Diamond' ? 'selected' : ''}>Diamond</option>
              <option ${stone.type === 'Ruby' ? 'selected' : ''}>Ruby</option>
              <option ${stone.type === 'Emerald' ? 'selected' : ''}>Emerald</option>
              <option ${stone.type === 'Moissanite' ? 'selected' : ''}>Moissanite</option>
              <option ${stone.type === 'Other' ? 'selected' : ''}>Other</option>
            </select>
            <button onclick="removeStone(${stone.id})" class="text-red-400 hover:text-yellow-300"><i class="fas fa-times"></i></button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-[10px] text-gray-500 uppercase">Carats</label>
              <input type="number" step="0.01" value="${stone.carats}" oninput="updateStone(${stone.id}, 'carats', this.value)" class="w-full px-2 py-2">
            </div>
            <div>
              <label class="text-[10px] text-gray-500 uppercase">Price/Ct</label>
              <input type="number" step="1" value="${stone.price}" oninput="updateStone(${stone.id}, 'price', this.value)" class="w-full px-2 py-2">
            </div>
          </div>
        </div>
      `).join('');
    }

    function addLaborRow() {
      appState.labor.push({ id: Date.now(), description: 'New Service', qty: 1, unit: 'Piece', price: 0 });
      renderLabor();
      updatePreview();
    }

    function removeLabor(id) {
      appState.labor = appState.labor.filter((item) => item.id !== id);
      renderLabor();
      updatePreview();
    }

    function updateLabor(id, field, value) {
      const item = appState.labor.find((entry) => entry.id === id);
      if (!item) return;
      item[field] = (field === 'description' || field === 'unit') ? value : parseFloat(value) || 0;
      updatePreview();
    }

    function renderLabor() {
      const container = document.getElementById('labor-container');
      container.innerHTML = appState.labor.map((item) => `
        <div class="panel p-3 space-y-2">
          <div class="flex justify-between items-center gap-3">
            <input type="text" value="${item.description}" oninput="updateLabor(${item.id}, 'description', this.value)" class="text-xs font-bold w-full px-2 py-2">
            <button onclick="removeLabor(${item.id})" class="text-red-400 hover:text-yellow-300"><i class="fas fa-times"></i></button>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="text-[10px] text-gray-500 uppercase">Qty</label>
              <input type="number" value="${item.qty}" oninput="updateLabor(${item.id}, 'qty', this.value)" class="w-full px-2 py-2">
            </div>
            <div>
              <label class="text-[10px] text-gray-500 uppercase">Unit</label>
              <input type="text" value="${item.unit}" oninput="updateLabor(${item.id}, 'unit', this.value)" class="w-full px-2 py-2">
            </div>
            <div>
              <label class="text-[10px] text-gray-500 uppercase">Price</label>
              <input type="number" value="${item.price}" oninput="updateLabor(${item.id}, 'price', this.value)" class="w-full px-2 py-2">
            </div>
          </div>
        </div>
      `).join('');
    }

    function updatePreview() {
      appState.clientName = document.getElementById('client-name').value || 'CLIENT NAME';
      appState.clientAddress = document.getElementById('client-address').value || 'Shipping Address Details';
      appState.invoiceNumber = document.getElementById('invoice-number').value || 'HZ-0000';
      appState.date = document.getElementById('invoice-date').value;
      appState.metal.weight = parseFloat(document.getElementById('metal-weight').value) || 0;
      appState.metal.loss = parseFloat(document.getElementById('metal-loss').value) || 0;
      appState.metal.unitPrice = parseFloat(document.getElementById('metal-unit-price').value) || 0;
      appState.vat = parseFloat(document.getElementById('vat-percent').value) || 0;
      appState.deposit = parseFloat(document.getElementById('deposit-amount').value) || 0;

      document.getElementById('preview-client-name').textContent = appState.clientName;
      document.getElementById('preview-client-address').textContent = appState.clientAddress;
      document.getElementById('preview-invoice-num').textContent = appState.invoiceNumber;
      document.getElementById('preview-date').textContent = new Date(appState.date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });

      const previewImg = document.getElementById('preview-image');
      const placeholder = document.getElementById('image-placeholder');
      if (appState.image) {
        previewImg.src = appState.image;
        previewImg.classList.remove('hidden');
        placeholder.classList.add('hidden');
      } else {
        previewImg.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }

      const tbody = document.getElementById('preview-table-body');
      tbody.innerHTML = '';
      let subtotal = 0;

      const lossGrams = appState.metal.weight * (appState.metal.loss / 100);
      const totalMetalUsed = appState.metal.weight + lossGrams;
      const metalTotal = totalMetalUsed * (appState.metal.unitPrice * appState.metal.purity);
      subtotal += metalTotal;

      const metalRow = document.createElement('tr');
      const metalName = document.getElementById('metal-type').options[document.getElementById('metal-type').selectedIndex].text;
      metalRow.innerHTML = `
        <td>
          <div style="font-weight: bold; font-size: 10pt;">${metalName}</div>
          <div style="font-size: 8pt; color: #6b7280;">Finished Wt: ${appState.metal.weight.toFixed(2)}g + ${appState.metal.loss}% loss (${lossGrams.toFixed(2)}g)</div>
          <div style="font-size: 8pt; color: #6b7280;">Purity: ${(appState.metal.purity * 100).toFixed(1)}%</div>
        </td>
        <td style="text-align: center;">${totalMetalUsed.toFixed(2)} g</td>
        <td style="text-align: right;">$${(appState.metal.unitPrice * appState.metal.purity).toFixed(2)}</td>
        <td class="total-column">$${metalTotal.toFixed(2)}</td>
      `;
      tbody.appendChild(metalRow);

      appState.stones.forEach((stone) => {
        const stoneTotal = stone.carats * stone.price;
        subtotal += stoneTotal;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="font-weight: bold; font-size: 10pt;">${stone.type}</div>
            <div style="font-size: 8pt; color: #6b7280;">Natural or selected stone input</div>
          </td>
          <td style="text-align: center;">${stone.carats.toFixed(2)} ct</td>
          <td style="text-align: right;">$${stone.price.toLocaleString()}</td>
          <td class="total-column">$${stoneTotal.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });

      appState.labor.forEach((item) => {
        const itemTotal = item.qty * item.price;
        subtotal += itemTotal;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><div style="font-weight: bold; font-size: 10pt;">${item.description}</div></td>
          <td style="text-align: center;">${item.qty} ${item.unit}</td>
          <td style="text-align: right;">$${item.price.toLocaleString()}</td>
          <td class="total-column">$${itemTotal.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });

      const vatAmount = subtotal * (appState.vat / 100);
      const grandTotal = subtotal + vatAmount;
      const balance = grandTotal - appState.deposit;

      document.getElementById('preview-subtotal').textContent = `$${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('preview-vat-rate').textContent = appState.vat;
      document.getElementById('preview-vat-amount').textContent = `$${vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('preview-grand-total').textContent = `$${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('preview-deposit').textContent = `-$${appState.deposit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('preview-balance').textContent = `$${balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    async function fetchMetalPrice() {
      const apiKey = appState.apiKey;
      if (!apiKey) {
        alert('Set your GoldAPI.io key first. It will only exist in this tab and will not be saved.');
        return;
      }

      const btn = document.getElementById('fetch-btn');
      const status = document.getElementById('spot-status');
      const metalSymbol = appState.metal.type;

      if (metalSymbol === 'CUSTOM') {
        alert('Cannot fetch spot price for custom metal.');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Fetching...';
      status.textContent = 'Connecting to GoldAPI...';

      try {
        const response = await fetch(`https://www.goldapi.io/api/${metalSymbol}/USD`, {
          headers: { 'x-access-token': apiKey }
        });
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        const pricePerGram = data.price / 31.1034768;
        document.getElementById('metal-unit-price').value = pricePerGram.toFixed(2);
        status.textContent = `Live spot loaded: $${pricePerGram.toFixed(2)}/g. Key remains unsaved.`;
        updatePreview();
      } catch (error) {
        console.error(error);
        status.textContent = 'Fetch failed. Check the API key or enter a manual price.';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Fetch Spot';
      }
    }

    function createNewQuotation() {
      if (!confirm('Start a new private quote? Current unsaved inputs will be cleared.')) return;
      appState.clientName = '';
      appState.clientAddress = '';
      appState.invoiceNumber = 'HZ-' + Math.floor(1000 + Math.random() * 9000);
      appState.date = new Date().toISOString().split('T')[0];
      appState.image = '';
      appState.stones = [];
      appState.labor = [
        { id: Date.now(), description: 'Casting / Setting / Finishing Labour', qty: 1, unit: 'Piece', price: 200 },
        { id: Date.now() + 1, description: 'Plating / Surface Treatment', qty: 1, unit: 'Piece', price: 45 }
      ];
      appState.vat = 0;
      appState.deposit = 0;

      document.getElementById('client-name').value = '';
      document.getElementById('client-address').value = '';
      document.getElementById('invoice-number').value = appState.invoiceNumber;
      document.getElementById('invoice-date').value = appState.date;
      document.getElementById('metal-weight').value = 19.0;
      document.getElementById('metal-loss').value = 11.0;
      document.getElementById('metal-unit-price').value = 0;
      document.getElementById('vat-percent').value = 0;
      document.getElementById('deposit-amount').value = 0;
      document.getElementById('image-upload').value = '';

      renderStones();
      renderLabor();
      updatePreview();
    }

    function loadSampleData() {
      appState.clientName = 'Sample Client';
      appState.clientAddress = '123 Precision Arcade\nSilom District\nBangkok 10500';
      appState.invoiceNumber = 'HZ-8888';
      appState.metal.weight = 19.0;
      appState.metal.loss = 11.0;
      appState.metal.unitPrice = 65.5;
      appState.stones = [
        { id: 1, type: 'Sapphire', carats: 2.5, price: 1200 },
        { id: 2, type: 'Diamond', carats: 0.8, price: 4500 }
      ];
      appState.vat = 7;
      appState.deposit = 5000;

      document.getElementById('client-name').value = appState.clientName;
      document.getElementById('client-address').value = appState.clientAddress;
      document.getElementById('invoice-number').value = appState.invoiceNumber;
      document.getElementById('metal-weight').value = appState.metal.weight;
      document.getElementById('metal-loss').value = appState.metal.loss;
      document.getElementById('metal-unit-price').value = appState.metal.unitPrice;
      document.getElementById('vat-percent').value = appState.vat;
      document.getElementById('deposit-amount').value = appState.deposit;

      renderStones();
      renderLabor();
      updatePreview();
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const element = document.getElementById('invoice-preview');
      const btn = document.querySelector('button[onclick="exportPDF()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Generating...';
      btn.disabled = true;

      try {
        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#fffdf8'
        });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Quotation_${appState.invoiceNumber}_${appState.clientName.replace(/\s+/g, '_')}.pdf`);
      } catch (error) {
        console.error('PDF generation error:', error);
        alert('Failed to generate PDF. Use print to PDF as fallback.');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
